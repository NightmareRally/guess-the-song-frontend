<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Song Game</title>
  <style>
    /* Base Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #ddd;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #b892ff;
      text-shadow: 0 0 10px #b892ff66;
      font-size: 2.25rem;
    }

    input[type="text"],
    select {
      background-color: #1f1f2e;
      border: 1.5px solid #6f47ff;
      color: #eee;
      padding: 12px 15px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #b892ff;
      outline: none;
      box-shadow: 0 0 8px #b892ff88;
    }

    button {
      background-color: #6f47ff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      margin: 8px 0;
      font-weight: 600;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 0 5px #6f47ffcc;
      flex-shrink: 0;
    }

    button:hover {
      background-color: #b892ff;
      box-shadow: 0 0 15px #b892ffdd;
    }

    #gameControls {
      margin-top: 30px;
      border: 1.5px solid #6f47ff;
      border-radius: 12px;
      padding: 25px 20px 30px 20px;
      background: #1a1a2e;
      box-shadow: 0 0 15px #6f47ff44;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #scoreDisplay {
      font-size: 20px;
      color: #b892ff;
      font-weight: 700;
      margin-bottom: 15px;
      display: inline-block;
      user-select: text;
    }

    #answer,
    #feedback,
    #hintDuration,
    #message {
      margin-top: 12px;
      font-weight: 600;
      color: #ddd;
      user-select: text;
    }

    .autocomplete-list {
      border: 1px solid #5548ff;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: #2c2c4a;
      width: 100%;
      z-index: 1000;
      border-radius: 8px;
      user-select: none;
      box-sizing: border-box;
    }

    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      color: #ddd;
      transition: background-color 0.2s ease;
    }

    .autocomplete-item:hover {
      background-color: #6f47ffaa;
      color: white;
    }

    .input-container {
      position: relative;
      margin-bottom: 20px;
      width: 100%;
    }

    #loader {
      display: none;
      margin: 20px auto;
      width: 45px;
      height: 45px;
      border: 5px solid #6f47ff;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    #continueBtn {
      display: none;
    }

    /* Flex layout for buttons row */
    #buttonRow {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    #buttonRow > button {
      flex: 1 1 120px;
      min-width: 120px;
    }

    /* Smaller fonts and spacing on small devices */
    @media (max-width: 400px) {
      body {
        padding: 15px 12px;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      input[type="text"],
      select {
        font-size: 14px;
        padding: 10px 12px;
      }

      button {
        font-size: 14px;
        padding: 10px 14px;
        min-width: 100px;
      }

      #scoreDisplay {
        font-size: 18px;
      }
    }

    /* Adjust autocomplete z-index on mobile to ensure visibility */
    @media (max-width: 600px) {
      .autocomplete-list {
        font-size: 14px;
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Scoreboard styling */
    #scoreboard {
      margin-top: 20px;
      background: #2a2a4a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px #b892ffaa;
      user-select: text;
    }

    #scoreboard h2 {
      color: #b892ff;
      margin-bottom: 15px;
      text-align: center;
    }

    #scoreboard table {
      width: 100%;
      border-collapse: collapse;
      color: #ddd;
    }

    #scoreboard th,
    #scoreboard td {
      padding: 10px;
      border-bottom: 1px solid #5548ff;
      text-align: center;
    }

    #scoreboard th {
      background-color: #6f47ff;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <h1>Guess the Song Game</h1>

  <label for="modeSelect">Choose Mode:</label>
  <select id="modeSelect">
    <option value="infinite">Infinite Mode</option>
    <option value="challenge">Challenge Mode (5 songs, 25 points)</option>
    <option value="multiplayer">Multiplayer Mode</option>
  </select>

  <div id="multiplayerSetup" style="display:none; margin-top:15px;">
    <label for="numPlayersSelect">Number of Players (2-6):</label>
    <select id="numPlayersSelect">
      <option value="" selected disabled>Select number of players</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>

    <div id="playerNamesInputs" style="margin-top: 15px;"></div>
    <button id="startMultiplayerBtn" style="margin-top: 15px; display:none;">Start Multiplayer Game</button>
  </div>

  <input id="playlistUrl" type="text" placeholder="Paste Spotify Playlist URL here" style="margin-top: 15px;" />
  <button onclick="loadPlaylist()">Load Playlist</button>

  <div id="loader"></div>

  <p id="message"></p>

  <div id="gameControls" style="display:none;">
    <p><strong>Score:</strong> <span id="scoreDisplay">0</span></p>
    <p id="currentPlayerDisplay" style="font-weight:700; margin-bottom: 10px;"></p>

    <div id="buttonRow">
      <button id="playBtn" onclick="playHint()">Play</button>
      <button id="nextHintBtn" onclick="nextHint()">Next Hint</button>
      <button id="giveUpBtn" onclick="revealAnswer()">I Give Up</button>
      <button id="nextSongBtn" style="display:none;">Next Song</button>
    </div>

    <div style="margin-top: 20px;">
      <div class="input-container">
        <input id="guessSongInput" type="text" placeholder="Guess the song name..." autocomplete="off" />
        <div id="songAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>
      <div class="input-container">
        <input id="guessArtistInput" type="text" placeholder="Guess the artist name..." autocomplete="off" />
        <div id="artistAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>
      <button id="submitGuessBtn" onclick="submitGuess()">Submit Guess</button>
    </div>

    <p id="hintDuration"></p>
    <p id="feedback"></p>
    <p id="answer" style="display:none;"></p>
  </div>

  <button id="playAgainBtn" onclick="playAgain()" style="display:none; margin-top: 30px;">Play Again</button>

  <div id="scoreboard" style="display:none;"></div>

  <script>
    const backendUrl = 'https://guess-the-song-backend.onrender.com';
    let songs = [];
    let usedSongs = new Set();
    let currentSong = null;
    let audio = null;
    let hintStages = [0.5, 1, 2, 5, 10, 15];
    let scoring = [10, 8, 6, 4, 2, 1];
    let currentHintIndex = 0;
    let snippetTimeout = null;
    let score = 0;
    let roundOver = false;

    let mode = 'infinite';
    const challengeMaxSongs = 5;
    const challengeGoalPoints = 25;
    let songsPlayed = 0;

    // Multiplayer variables
    let players = [];
    let currentPlayerIndex = 0;
    let totalRounds = 5;
    let currentRound = 1;

    const messageP = document.getElementById('message');
    const loader = document.getElementById('loader');
    const gameControls = document.getElementById('gameControls');
    const nextSongBtn = document.getElementById('nextSongBtn');
    const currentPlayerDisplay = document.getElementById('currentPlayerDisplay');
    const multiplayerSetup = document.getElementById('multiplayerSetup');
    const numPlayersSelect = document.getElementById('numPlayersSelect');
    const playerNamesInputs = document.getElementById('playerNamesInputs');
    const startMultiplayerBtn = document.getElementById('startMultiplayerBtn');

    // Show/hide multiplayer setup based on mode select
    document.getElementById('modeSelect').addEventListener('change', () => {
      mode = document.getElementById('modeSelect').value;
      resetMultiplayerSetup();
      if (mode === 'multiplayer') {
        multiplayerSetup.style.display = 'block';
      } else {
        multiplayerSetup.style.display = 'none';
      }
      resetGameState();
    });

    // When number of players selected, show inputs for player names
    numPlayersSelect.addEventListener('change', () => {
      const count = parseInt(numPlayersSelect.value);
      playerNamesInputs.innerHTML = '';
      if (count >= 2 && count <= 6) {
        for (let i = 0; i < count; i++) {
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = `Player ${i + 1} Name`;
          input.required = true;
          input.style.marginBottom = '8px';
          playerNamesInputs.appendChild(input);
        }
        startMultiplayerBtn.style.display = 'inline-block';
      } else {
        startMultiplayerBtn.style.display = 'none';
      }
    });

    // Start multiplayer game: read player names, init players array, and start game if playlist loaded
    startMultiplayerBtn.addEventListener('click', () => {
      const inputs = playerNamesInputs.querySelectorAll('input');
      players = [];
      let allFilled = true;
      inputs.forEach((input, i) => {
        const name = input.value.trim();
        if (!name) allFilled = false;
        players.push({ name: name || `Player ${i + 1}`, score: 0 });
      });
      if (!allFilled) {
        alert('Please fill in all player names.');
        return;
      }
      resetGameState();
      if (songs.length === 0) {
        alert('Load a playlist first!');
        return;
      }
      multiplayerSetup.style.display = 'none';
      startMultiplayerGame();
    });

    function resetMultiplayerSetup() {
      multiplayerSetup.style.display = 'none';
      playerNamesInputs.innerHTML = '';
      startMultiplayerBtn.style.display = 'none';
      numPlayersSelect.value = '';
    }

    function resetGameState() {
      usedSongs.clear();
      score = 0;
      songsPlayed = 0;
      currentRound = 1;
      currentPlayerIndex = 0;
      players.forEach(p => p.score = 0);
      messageP.textContent = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('answer').style.display = 'none';
      document.getElementById('playAgainBtn').style.display = 'none';
      document.getElementById('scoreboard').style.display = 'none';
      updateScore(0);
      resetButtons(true);
      enableInputs(true);
    }

    async function loadPlaylist() {
      const playlistUrl = document.getElementById('playlistUrl').value.trim();
      const playlistId = extractPlaylistId(playlistUrl);

      if (!playlistId) {
        alert('Please enter a valid Spotify playlist URL.');
        return;
      }

      loader.style.display = 'block';

      try {
        const response = await fetch(`${backendUrl}/playlist/${playlistId}`);
        if (!response.ok) {
          alert('Failed to load playlist.');
          loader.style.display = 'none';
          return;
        }

        const data = await response.json();
        songs = data.filter(song => song.preview_url);
        if (songs.length === 0) {
          alert('No playable songs found.');
          loader.style.display = 'none';
          return;
        }

        if (mode !== 'multiplayer') {
          songsPlayed = 0;
          score = 0;
          updateScore(0);
          gameControls.style.display = 'block';
          resetButtons(true);
          document.getElementById('playAgainBtn').style.display = 'none';
          enableInputs(true);
          startNewRound();
        } else {
          alert('Playlist loaded! Now enter player names and start multiplayer game.');
          gameControls.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading playlist:', error);
        alert('Something went wrong.');
      } finally {
        loader.style.display = 'none';
      }
    }

    function extractPlaylistId(url) {
      const match = url.match(/playlist\/([a-zA-Z0-9]+)(\?.*)?$/);
      return match ? match[1] : null;
    }

    function resetButtons(active) {
      document.getElementById('playBtn').disabled = !active;
      document.getElementById('nextHintBtn').disabled = !active;
      document.getElementById('giveUpBtn').disabled = !active;
      document.getElementById('submitGuessBtn').disabled = !active;
      nextSongBtn.style.display = active ? 'none' : 'inline-block';
      if (mode === 'multiplayer') {
        nextSongBtn.textContent = 'Next Player';
      } else {
        nextSongBtn.textContent = 'Next Song';
      }
    }

    function enableInputs(enabled) {
      document.getElementById('guessSongInput').disabled = !enabled;
      document.getElementById('guessArtistInput').disabled = !enabled;
    }

    // === Single Player Modes ===
    function startNewRound() {
      if (mode === 'challenge' && songsPlayed >= challengeMaxSongs) {
        endGame();
        return;
      }

      roundOver = false;
      resetButtons(true);
      enableInputs(true);

      clearTimeout(snippetTimeout);
      if (audio) {
        audio.pause();
        audio = null;
      }

      currentHintIndex = 0;
      document.getElementById('answer').style.display = 'none';
      document.getElementById('answer').textContent = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('hintDuration').textContent = '';
      document.getElementById('guessSongInput').value = '';
      document.getElementById('guessArtistInput').value = '';
      hideAutocomplete('songAutocomplete');
      hideAutocomplete('artistAutocomplete');

      let attempts = 0;
      do {
        currentSong = songs[Math.floor(Math.random() * songs.length)];
        attempts++;
      } while (usedSongs.has(currentSong.name + currentSong.artist) && attempts < 10);

      usedSongs.add(currentSong.name + currentSong.artist);
      songsPlayed++;

      if (mode === 'challenge') {
        messageP.textContent = `Challenge Mode: Song ${songsPlayed} of ${challengeMaxSongs}`;
      } else {
        messageP.textContent = '';
      }
      document.getElementById('playAgainBtn').style.display = 'none';
    }

    // === Multiplayer Mode ===
    function startMultiplayerGame() {
      score = 0;
      songsPlayed = 0;
      usedSongs.clear();
      currentRound = 1;
      currentPlayerIndex = 0;
      players.forEach(p => p.score = 0);
      gameControls.style.display = 'block';
      resetButtons(true);
      enableInputs(true);
      messageP.textContent = `Round 1 / ${totalRounds} â€” ${players[0].name}'s turn`;
      updateCurrentPlayerDisplay();
      startNewTurn();
    }

    function startNewTurn() {
      if (currentRound > totalRounds) {
        endMultiplayerGame();
        return;
      }

      roundOver = false;
      resetButtons(true);
      enableInputs(true);

      clearTimeout(snippetTimeout);
      if (audio) {
        audio.pause();
        audio = null;
      }

      currentHintIndex = 0;
      document.getElementById('answer').style.display = 'none';
      document.getElementById('answer').textContent = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('hintDuration').textContent = '';
      document.getElementById('guessSongInput').value = '';
      document.getElementById('guessArtistInput').value = '';
      hideAutocomplete('songAutocomplete');
      hideAutocomplete('artistAutocomplete');

      let attempts = 0;
      do {
        currentSong = songs[Math.floor(Math.random() * songs.length)];
        attempts++;
      } while (usedSongs.has(currentSong.name + currentSong.artist) && attempts < 20);

      usedSongs.add(currentSong.name + currentSong.artist);

      messageP.textContent = `Round ${currentRound} / ${totalRounds} â€” ${players[currentPlayerIndex].name}'s turn`;

      updateCurrentPlayerDisplay();
      playHint();
    }

    nextSongBtn.onclick = () => {
      if (mode === 'multiplayer') {
        currentPlayerIndex++;
        if (currentPlayerIndex >= players.length) {
          currentPlayerIndex = 0;
          currentRound++;
        }

        if (currentRound > totalRounds) {
          endMultiplayerGame();
          return;
        }

        startNewTurn();
      } else {
        startNewRound();
      }
    };

    // === Gameplay ===
    function playHint() {
      if (!currentSong) {
        alert('No song selected!');
        return;
      }
      if (audio) {
        audio.pause();
      }

      const duration = hintStages[currentHintIndex];
      const snippetUrl = `${currentSong.preview_url}#t=0,${duration}`;

      audio = new Audio(snippetUrl);
      audio.play();

      document.getElementById('hintDuration').textContent = `Playing first ${duration} seconds`;

      if (snippetTimeout) clearTimeout(snippetTimeout);
      snippetTimeout = setTimeout(() => {
        if (audio) audio.pause();
      }, duration * 1000);
    }

    function nextHint() {
      if (roundOver) return;

      if (currentHintIndex < hintStages.length - 1) {
        currentHintIndex++;
        playHint();
      } else {
        document.getElementById('feedback').textContent = "No more hints! Try your guess or give up.";
      }
    }

    function revealAnswer() {
      if (!currentSong) return;
      roundOver = true;
      resetButtons(false);
      enableInputs(false);

      document.getElementById('answer').style.display = 'block';
      document.getElementById('answer').textContent = `Answer: "${currentSong.name}" by ${currentSong.artist}`;

      nextSongBtn.style.display = 'inline-block';
    }

    function submitGuess() {
      if (roundOver) return;

      const songGuess = document.getElementById('guessSongInput').value.trim().toLowerCase();
      const artistGuess = document.getElementById('guessArtistInput').value.trim().toLowerCase();

      if (!songGuess && !artistGuess) {
        alert('Please enter a guess.');
        return;
      }

      // Check if correct (simple check contains, case-insensitive)
      const correctSong = currentSong.name.toLowerCase();
      const correctArtist = currentSong.artist.toLowerCase();

      const songMatch = songGuess && correctSong.includes(songGuess);
      const artistMatch = artistGuess && correctArtist.includes(artistGuess);

      if ((songGuess && songMatch) || (artistGuess && artistMatch)) {
        roundOver = true;
        resetButtons(false);
        enableInputs(false);
        document.getElementById('feedback').textContent = 'Correct! ðŸŽ‰';

        // Update score
        let gainedPoints = 0;
        if (mode === 'challenge') {
          gainedPoints = scoring[currentHintIndex] || 1;
          score += gainedPoints;
          updateScore(score);
          if (score >= challengeGoalPoints || songsPlayed >= challengeMaxSongs) {
            endGame();
          }
        } else if (mode === 'multiplayer') {
          gainedPoints = scoring[currentHintIndex] || 1;
          players[currentPlayerIndex].score += gainedPoints;
          updateScoreDisplay();
        } else {
          gainedPoints = scoring[currentHintIndex] || 1;
          score += gainedPoints;
          updateScore(score);
        }

        document.getElementById('answer').style.display = 'block';
        document.getElementById('answer').textContent = `Answer: "${currentSong.name}" by ${currentSong.artist}`;
        nextSongBtn.style.display = 'inline-block';
        nextSongBtn.textContent = mode === 'multiplayer' ? 'Next Player' : 'Next Song';

        if (audio) {
          audio.pause();
          audio = null;
        }
      } else {
        document.getElementById('feedback').textContent = 'Wrong guess, try again or get a hint.';
      }
    }

    function updateScore(newScore) {
      document.getElementById('scoreDisplay').textContent = newScore;
    }

    function updateScoreDisplay() {
      if (mode === 'multiplayer') {
        // Show current player's score in the current player display (see below)
        updateCurrentPlayerDisplay();
      } else {
        updateScore(score);
      }
    }

    function updateCurrentPlayerDisplay() {
      if (mode === 'multiplayer') {
        const p = players[currentPlayerIndex];
        currentPlayerDisplay.textContent = `Current Player: ${p.name} | Round ${currentRound} / ${totalRounds} | Score: ${Math.round(p.score * 10) / 10}`;
      } else {
        currentPlayerDisplay.textContent = '';
      }
    }

    function endMultiplayerGame() {
      gameControls.style.display = 'none';
      document.getElementById('playAgainBtn').style.display = 'inline-block';
      messageP.textContent = `Game over! Here are the final scores:`;
      showScoreboard();
    }

    function endGame() {
      gameControls.style.display = 'none';
      document.getElementById('playAgainBtn').style.display = 'inline-block';
      messageP.textContent = `Game over! Your final score: ${score}`;
    }

    function showScoreboard() {
      const scoreboardDiv = document.getElementById('scoreboard');
      scoreboardDiv.style.display = 'block';
      players.sort((a, b) => b.score - a.score);

      let html = '<h2>Multiplayer Scores</h2><table><thead><tr><th>Place</th><th>Player</th><th>Score</th></tr></thead><tbody>';
      players.forEach((p, idx) => {
        const place = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : (idx + 1);
        html += `<tr><td>${place}</td><td>${p.name}</td><td>${Math.round(p.score * 10) / 10}</td></tr>`;
      });
      html += '</tbody></table>';
      scoreboardDiv.innerHTML = html;
    }

    function playAgain() {
      resetGameState();
      if (mode === 'multiplayer') {
        if (players.length === 0) {
          multiplayerSetup.style.display = 'block';
          gameControls.style.display = 'none';
          messageP.textContent = 'Load a playlist and enter player names to start multiplayer game.';
          document.getElementById('scoreboard').style.display = 'none';
        } else {
          startMultiplayerGame();
          document.getElementById('scoreboard').style.display = 'none';
        }
      } else {
        startNewRound();
        gameControls.style.display = 'block';
        document.getElementById('scoreboard').style.display = 'none';
        document.getElementById('playAgainBtn').style.display = 'none';
      }
    }

    // Autocomplete feature (basic)
    function hideAutocomplete(id) {
      document.getElementById(id).style.display = 'none';
      document.getElementById(id).innerHTML = '';
    }

    // For brevity, autocomplete is disabled here (can be added later if needed)

  </script>
</body>

</html>
