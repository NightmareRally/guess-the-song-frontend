<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Song Game</title>
  <style>
    /* Base Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #ddd;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #b892ff;
      text-shadow: 0 0 10px #b892ff66;
      font-size: 2.25rem;
    }

    input[type="text"],
    select {
      background-color: #1f1f2e;
      border: 1.5px solid #6f47ff;
      color: #eee;
      padding: 12px 15px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #b892ff;
      outline: none;
      box-shadow: 0 0 8px #b892ff88;
    }

    button {
      background-color: #6f47ff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      margin: 8px 0;
      font-weight: 600;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 0 5px #6f47ffcc;
      flex-shrink: 0;
    }

    button:hover {
      background-color: #b892ff;
      box-shadow: 0 0 15px #b892ffdd;
    }

    #gameControls {
      margin-top: 30px;
      border: 1.5px solid #6f47ff;
      border-radius: 12px;
      padding: 25px 20px 30px 20px;
      background: #1a1a2e;
      box-shadow: 0 0 15px #6f47ff44;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #scoreDisplay {
      font-size: 20px;
      color: #b892ff;
      font-weight: 700;
      margin-bottom: 15px;
      display: inline-block;
      user-select: text;
    }

    #answer,
    #feedback,
    #hintDuration,
    #message {
      margin-top: 12px;
      font-weight: 600;
      color: #ddd;
      user-select: text;
    }

    .autocomplete-list {
      border: 1px solid #5548ff;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: #2c2c4a;
      width: 100%;
      z-index: 1000;
      border-radius: 8px;
      user-select: none;
      box-sizing: border-box;
    }

    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      color: #ddd;
      transition: background-color 0.2s ease;
    }

    .autocomplete-item:hover {
      background-color: #6f47ffaa;
      color: white;
    }

    .input-container {
      position: relative;
      margin-bottom: 20px;
      width: 100%;
    }

    #loader {
      display: none;
      margin: 20px auto;
      width: 45px;
      height: 45px;
      border: 5px solid #6f47ff;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    #continueBtn {
      display: none;
    }

    /* Flex layout for buttons row */
    #buttonRow {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    #buttonRow>button {
      flex: 1 1 120px;
      min-width: 120px;
    }

    /* Smaller fonts and spacing on small devices */
    @media (max-width: 400px) {
      body {
        padding: 15px 12px;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      input[type="text"],
      select {
        font-size: 14px;
        padding: 10px 12px;
      }

      button {
        font-size: 14px;
        padding: 10px 14px;
        min-width: 100px;
      }

      #scoreDisplay {
        font-size: 18px;
      }
    }

    /* Adjust autocomplete z-index on mobile to ensure visibility */
    @media (max-width: 600px) {
      .autocomplete-list {
        font-size: 14px;
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #multiplayerSetup {
      background: #2a2a4a;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 0 10px #6f47ff99;
    }

    #scoreboard {
      margin-top: 30px;
      border: 1.5px solid #6f47ff;
      border-radius: 12px;
      padding: 20px;
      background: #1a1a2e;
      box-shadow: 0 0 15px #6f47ff44;
      color: #b892ff;
    }

    #scoreboard h2 {
      margin-top: 0;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
    }

    #scoreboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #scoreboard li {
      padding: 10px;
      border-bottom: 1px solid #6f47ff55;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
    }

    #scoreboard li:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <h1>Guess the Song Game</h1>

  <label for="modeSelect">Choose Mode:</label>
  <select id="modeSelect">
    <option value="infinite">Infinite Mode</option>
    <option value="challenge">Challenge Mode (5 songs, 25 points)</option>
    <option value="multiplayer">Multiplayer</option>
  </select>

  <input id="playlistUrl" type="text" placeholder="Paste Spotify Playlist URL here" />
  <button id="loadPlaylistBtn">Load Playlist</button>

  <div id="loader"></div>

  <p id="message"></p>

  <div id="multiplayerSetup" style="display:none;">
    <label for="playerCountSelect">Number of Players:</label>
    <select id="playerCountSelect">
      <option value="">Select number of players</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>
    <div id="playerNamesContainer" style="margin-top:15px;"></div>
    <button id="startMultiplayerBtn" style="margin-top: 15px;" disabled>Start Multiplayer Game</button>
  </div>

  <div id="gameControls" style="display:none;">
    <p id="currentPlayerP" style="font-weight:700; color:#b892ff; margin-bottom:10px;"></p>
    <p><strong>Score:</strong> <span id="scoreDisplay">0</span></p>

    <div id="buttonRow">
      <button id="playBtn" onclick="playHint()">Play</button>
      <button id="nextHintBtn" onclick="nextHint()">Next Hint</button>
      <button id="giveUpBtn" onclick="revealAnswer()">I Give Up</button>
      <button id="nextSongBtn" style="display:none;">Next Song</button>
    </div>

    <div style="margin-top: 20px;">
      <div class="input-container">
        <input id="guessSongInput" type="text" placeholder="Guess the song name..." autocomplete="off" />
        <div id="songAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>
      <div class="input-container">
        <input id="guessArtistInput" type="text" placeholder="Guess the artist name..." autocomplete="off" />
        <div id="artistAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>
      <button id="submitGuessBtn">Submit Guess</button>
    </div>

    <p id="hintDuration"></p>
    <p id="feedback"></p>
    <p id="answer" style="display:none;"></p>
  </div>

  <button id="playAgainBtn" onclick="playAgain()" style="display:none; margin-top: 30px;">Play Again</button>

  <div id="scoreboard" style="display:none;">
    <h2>Game Over â€” Scoreboard</h2>
    <ul id="scoreboardList"></ul>
    <button id="restartBtn" style="margin-top: 20px;">Play Again</button>
  </div>

  <script>
    const backendUrl = 'https://guess-the-song-backend.onrender.com';
    let songs = [];
    let usedSongs = new Set();
    let currentSong = null;
    let audio = null;
    let hintStages = [0.5, 1, 2, 5, 10, 15];
    let scoring = [10, 8, 6, 4, 2, 1];
    let currentHintIndex = 0;
    let snippetTimeout = null;
    let score = 0;
    let roundOver = false;

    let mode = 'infinite';
    const challengeMaxSongs = 5;
    const challengeGoalPoints = 25;
    let songsPlayed = 0;

    // Multiplayer variables
    let players = [];
    let currentPlayerIndex = 0;
    const songsPerPlayer = 5;

    // DOM Elements
    const messageP = document.getElementById('message');
    const loader = document.getElementById('loader');
    const gameControls = document.getElementById('gameControls');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const nextSongBtn = document.getElementById('nextSongBtn');
    const currentPlayerP = document.getElementById('currentPlayerP');
    const multiplayerSetup = document.getElementById('multiplayerSetup');
    const playerCountSelect = document.getElementById('playerCountSelect');
    const playerNamesContainer = document.getElementById('playerNamesContainer');
    const startMultiplayerBtn = document.getElementById('startMultiplayerBtn');
    const scoreboard = document.getElementById('scoreboard');
    const scoreboardList = document.getElementById('scoreboardList');
    const restartBtn = document.getElementById('restartBtn');

    function updateScoreDisplay() {
      if (mode === 'multiplayer') {
        const player = players[currentPlayerIndex];
        document.getElementById('scoreDisplay').textContent = Math.round(player.score * 10) / 10;
      } else {
        document.getElementById('scoreDisplay').textContent = Math.round(score * 10) / 10;
      }
    }

    function extractPlaylistId(url) {
      const match = url.match(/playlist\/([a-zA-Z0-9]+)(\?.*)?$/);
      return match ? match[1] : null;
    }

    document.getElementById('loadPlaylistBtn').addEventListener('click', async () => {
      const playlistUrl = document.getElementById('playlistUrl').value.trim();
      const playlistId = extractPlaylistId(playlistUrl);

      if (!playlistId) {
        alert('Please enter a valid Spotify playlist URL.');
        return;
      }

      loader.style.display = 'block';
      multiplayerSetup.style.display = 'none';
      gameControls.style.display = 'none';
      scoreboard.style.display = 'none';
      messageP.textContent = '';

      try {
        const response = await fetch(`${backendUrl}/playlist/${playlistId}`);
        if (!response.ok) {
          alert('Failed to load playlist.');
          loader.style.display = 'none';
          return;
        }

        const data = await response.json();
        songs = data.filter(song => song.preview_url);
        if (songs.length === 0) {
          alert('No playable songs found.');
          loader.style.display = 'none';
          return;
        }

        mode = document.getElementById('modeSelect').value;
        songsPlayed = 0;
        score = 0;
        usedSongs.clear();

        if (mode === 'multiplayer') {
          // Show multiplayer setup UI
          multiplayerSetup.style.display = 'block';
          setupMultiplayer();
        } else {
          multiplayerSetup.style.display = 'none';
          gameControls.style.display = 'block';
          resetButtons(true);
          playAgainBtn.style.display = 'none';
          enableInputs(true);
          startNewRound();
        }
      } catch (error) {
        console.error('Error loading playlist:', error);
        alert('Something went wrong.');
      } finally {
        loader.style.display = 'none';
      }
    });

    // Multiplayer Setup handlers

    function setupMultiplayer() {
      players = [];
      currentPlayerIndex = 0;
      playerNamesContainer.innerHTML = '';
      startMultiplayerBtn.disabled = true;
      playerCountSelect.value = '';

      playerCountSelect.onchange = () => {
        playerNamesContainer.innerHTML = '';
        players = [];
        const count = parseInt(playerCountSelect.value);
        if (!count || count < 2 || count > 6) {
          startMultiplayerBtn.disabled = true;
          return;
        }
        for (let i = 0; i < count; i++) {
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = `Player ${i + 1} name`;
          input.style.marginBottom = '10px';
          input.required = true;
          playerNamesContainer.appendChild(input);
          players.push({ name: '', score: 0, songsPlayed: 0, inputElement: input });
          input.oninput = checkAllNamesFilled;
        }
        checkAllNamesFilled();
      };

      startMultiplayerBtn.onclick = () => {
        // Save player names
        let allFilled = true;
        players.forEach(p => {
          p.name = p.inputElement.value.trim();
          if (!p.name) allFilled = false;
        });
        if (!allFilled) {
          alert('Please enter all player names.');
          return;
        }

        multiplayerSetup.style.display = 'none';
        gameControls.style.display = 'block';
        messageP.textContent = '';
        usedSongs.clear();
        score = 0;
        songsPlayed = 0;
        currentPlayerIndex = 0;
        resetButtons(true);
        enableInputs(true);
        updateCurrentPlayerDisplay();
        startNewRound();
      };
    }

    function checkAllNamesFilled() {
      const allFilled = players.every(p => p.inputElement.value.trim() !== '');
      startMultiplayerBtn.disabled = !allFilled;
    }

    function updateCurrentPlayerDisplay() {
      if (mode === 'multiplayer') {
        currentPlayerP.textContent = `Current Player: ${players[currentPlayerIndex].name} | Score: ${Math.round(players[currentPlayerIndex].score * 10) / 10}`;
      } else {
        currentPlayerP.textContent = '';
      }
      updateScoreDisplay();
    }

    function resetButtons(active) {
      document.getElementById('playBtn').disabled = !active;
      document.getElementById('nextHintBtn').disabled = !active;
      document.getElementById('giveUpBtn').disabled = !active;
      document.getElementById('submitGuessBtn').disabled = !active;
      nextSongBtn.style.display = active ? 'none' : 'inline-block';
    }

    function enableInputs(enabled) {
      document.getElementById('guessSongInput').disabled = !enabled;
      document.getElementById('guessArtistInput').disabled = !enabled;
    }

    function startNewRound() {
      // Multiplayer: if current player finished their 5 songs, go to next player or end game
      if (mode === 'multiplayer') {
        if (players[currentPlayerIndex].songsPlayed >= songsPerPlayer) {
          currentPlayerIndex++;
          if (currentPlayerIndex >= players.length) {
            endMultiplayerGame();
            return;
          } else {
            updateCurrentPlayerDisplay();
          }
        }
      }

      if (mode === 'challenge' && songsPlayed >= challengeMaxSongs) {
        endGame();
        return;
      }

      roundOver = false;
      resetButtons(true);
      enableInputs(true);

      clearTimeout(snippetTimeout);
      if (audio) {
        audio.pause();
        audio = null;
      }

      currentHintIndex = 0;
      document.getElementById('answer').style.display = 'none';
      document.getElementById('answer').textContent = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('hintDuration').textContent = '';
      document.getElementById('guessSongInput').value = '';
      document.getElementById('guessArtistInput').value = '';
      hideAutocomplete('songAutocomplete');
      hideAutocomplete('artistAutocomplete');

      // Pick a new song that hasn't been used by this player
      let attempts = 0;
      do {
        currentSong = songs[Math.floor(Math.random() * songs.length)];
        attempts++;
      } while (usedSongs.has(currentSong.name + currentSong.artist) && attempts < 20);

      usedSongs.add(currentSong.name + currentSong.artist);

      if (mode === 'multiplayer') {
        players[currentPlayerIndex].songsPlayed++;
      } else {
        songsPlayed++;
      }

      if (mode === 'challenge') {
        messageP.textContent = `Challenge Mode: Song ${songsPlayed} of ${challengeMaxSongs}`;
      } else {
        messageP.textContent = '';
      }

      updateCurrentPlayerDisplay();
      playHint();
    }

    function playHint() {
      if (roundOver) return;

      if (audio) {
        audio.pause();
        audio = null;
      }

      if (currentHintIndex >= hintStages.length) {
        // No more hints
        return;
      }

      const seconds = hintStages[currentHintIndex];
      document.getElementById('hintDuration').textContent = `Playing first ${seconds} second${seconds > 1 ? 's' : ''} of the song`;
      audio = new Audio(currentSong.preview_url);

      audio.currentTime = 0;
      audio.play();

      snippetTimeout = setTimeout(() => {
        audio.pause();
        audio = null;
        document.getElementById('hintDuration').textContent = '';
      }, seconds * 1000);

      currentHintIndex++;
    }

    function nextHint() {
      if (roundOver) return;
      playHint();
    }

    function revealAnswer() {
      if (roundOver) return;
      roundOver = true;
      if (audio) {
        audio.pause();
        audio = null;
      }
      document.getElementById('answer').style.display = 'block';
      document.getElementById('answer').textContent = `Answer: "${currentSong.name}" by ${currentSong.artist}`;
      resetButtons(false);
      enableInputs(false);

      // Show Next Player or Next Song button with correct text
      nextSongBtn.style.display = 'inline-block';
      if (mode === 'multiplayer') {
        nextSongBtn.textContent = 'Next Player';
      } else {
        nextSongBtn.textContent = 'Next Song';
      }
    }

    function submitGuess() {
      if (roundOver) return;

      const guessSong = document.getElementById('guessSongInput').value.trim().toLowerCase();
      const guessArtist = document.getElementById('guessArtistInput').value.trim().toLowerCase();

      if (!guessSong && !guessArtist) {
        alert('Please enter a guess for song name or artist.');
        return;
      }

      const actualSong = currentSong.name.toLowerCase();
      const actualArtist = currentSong.artist.toLowerCase();

      let correctSong = guessSong && actualSong.includes(guessSong);
      let correctArtist = guessArtist && actualArtist.includes(guessArtist);

      if (correctSong && correctArtist) {
        finishRound(true);
      } else if (correctSong) {
        finishRound(true);
      } else if (correctArtist) {
        finishRound(false);
      } else {
        document.getElementById('feedback').textContent = 'Incorrect guess, try again!';
      }
    }

    function finishRound(correctSongAndArtist) {
      roundOver = true;
      if (audio) {
        audio.pause();
        audio = null;
      }

      // Calculate points
      let points = 0;
      if (correctSongAndArtist) {
        points = scoring[Math.min(currentHintIndex - 1, scoring.length - 1)] || 1;
        document.getElementById('feedback').textContent = `Correct! You earned ${points} point${points > 1 ? 's' : ''}.`;
      } else {
        points = (scoring[Math.min(currentHintIndex - 1, scoring.length - 1)] || 1) / 2;
        document.getElementById('feedback').textContent = `Partial correct (artist only). You earned ${points.toFixed(1)} points.`;
      }

      if (mode === 'multiplayer') {
        players[currentPlayerIndex].score += points;
      } else {
        score += points;
      }

      updateScoreDisplay();

      // Show answer and Next Player / Next Song button
      document.getElementById('answer').style.display = 'block';
      document.getElementById('answer').textContent = `Answer: "${currentSong.name}" by ${currentSong.artist}`;
      resetButtons(false);
      enableInputs(false);

      nextSongBtn.style.display = 'inline-block';
      nextSongBtn.textContent = mode === 'multiplayer' ? 'Next Player' : 'Next Song';

      // Check end of game for challenge mode
      if (mode === 'challenge' && songsPlayed >= challengeMaxSongs) {
        // Disable next song if game over
        nextSongBtn.textContent = 'View Results';
      }
    }

    nextSongBtn.onclick = () => {
      if (mode === 'multiplayer') {
        // If current player finished their songs, advance to next player or end game
        if (players[currentPlayerIndex].songsPlayed >= songsPerPlayer) {
          currentPlayerIndex++;
          if (currentPlayerIndex >= players.length) {
            endMultiplayerGame();
            return;
          }
          updateCurrentPlayerDisplay();
        }
        startNewRound();
      } else if (mode === 'challenge' && songsPlayed >= challengeMaxSongs) {
        endGame();
      } else {
        startNewRound();
      }
    };

    function endMultiplayerGame() {
      gameControls.style.display = 'none';
      scoreboard.style.display = 'block';
      messageP.textContent = '';

      // Sort players by score descending
      players.sort((a, b) => b.score - a.score);

      scoreboardList.innerHTML = '';
      players.forEach((p, idx) => {
        const li = document.createElement('li');
        li.textContent = `${idx + 1}. ${p.name}`;
        const scoreSpan = document.createElement('span');
        scoreSpan.textContent = `${Math.round(p.score * 10) / 10} points`;
        li.appendChild(scoreSpan);
        scoreboardList.appendChild(li);
      });
    }

    function endGame() {
      gameControls.style.display = 'none';
      scoreboard.style.display = 'block';
      messageP.textContent = '';

      scoreboardList.innerHTML = '';
      let finalScore = mode === 'challenge' ? score : 0;

      const li = document.createElement('li');
      li.textContent = `Final Score: ${Math.round(score * 10) / 10} points`;
      scoreboardList.appendChild(li);
    }

    restartBtn.onclick = () => {
      scoreboard.style.display = 'none';
      score = 0;
      songsPlayed = 0;
      usedSongs.clear();
      players = [];
      currentPlayerIndex = 0;
      multiplayerSetup.style.display = 'none';
      gameControls.style.display = 'none';
      messageP.textContent = '';
      document.getElementById('playlistUrl').value = '';
      document.getElementById('modeSelect').value = 'infinite';
    };

    // Autocomplete feature for inputs (optional)

    // Simple autocomplete helper functions omitted here for brevity but can be added as needed

    // Attach submit guess button
    document.getElementById('submitGuessBtn').addEventListener('click', submitGuess);

    // Enter key submits guess
    document.getElementById('guessSongInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitGuess();
    });

    document.getElementById('guessArtistInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitGuess();
    });
  </script>
</body>

</html>
