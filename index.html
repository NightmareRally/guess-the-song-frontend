<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Guess the Song Game</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #ddd;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      user-select: none;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #b892ff;
      text-shadow: 0 0 10px #b892ff66;
    }

    input[type="text"],
    select {
      background-color: #1f1f2e;
      border: 1.5px solid #6f47ff;
      color: #eee;
      padding: 12px 15px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #b892ff;
      outline: none;
      box-shadow: 0 0 8px #b892ff88;
    }

    button {
      background-color: #6f47ff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      margin: 8px 0;
      font-weight: 600;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 0 5px #6f47ffcc;
    }

    button:hover {
      background-color: #b892ff;
      box-shadow: 0 0 15px #b892ffdd;
    }

    #gameControls {
      margin-top: 30px;
      border: 1.5px solid #6f47ff;
      border-radius: 12px;
      padding: 25px 20px 30px 20px;
      background: #1a1a2e;
      box-shadow: 0 0 15px #6f47ff44;
    }

    #scoreDisplay {
      font-size: 20px;
      color: #b892ff;
      font-weight: 700;
      margin-bottom: 15px;
      display: inline-block;
      user-select: text;
    }

    #player1Score,
    #player2Score {
      font-size: 18px;
      font-weight: 700;
      margin-right: 20px;
      user-select: text;
      color: #b892ff;
      display: inline-block;
    }

    #currentPlayer {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      color: #b892ff;
      user-select: text;
      text-align: center;
    }

    #answer,
    #feedback,
    #hintDuration,
    #message {
      margin-top: 12px;
      font-weight: 600;
      color: #ddd;
      user-select: text;
    }

    .autocomplete-list {
      border: 1px solid #5548ff;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: #2c2c4a;
      width: 100%;
      z-index: 1000;
      border-radius: 8px;
      user-select: none;
    }

    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      color: #ddd;
      transition: background-color 0.2s ease;
    }

    .autocomplete-item:hover {
      background-color: #6f47ffaa;
      color: white;
    }

    .input-container {
      position: relative;
      margin-bottom: 20px;
    }

    #loader {
      display: none;
      margin: 20px auto;
      width: 45px;
      height: 45px;
      border: 5px solid #6f47ff;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    #continueBtn {
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <h1>Guess the Song Game</h1>

  <label for="modeSelect">Choose Mode:</label>
  <select id="modeSelect">
    <option value="infinite">Infinite Mode</option>
    <option value="challenge">Challenge Mode (5 songs, 25 points)</option>
    <option value="2player">2 Player Mode (5 songs each, alternate turns)</option>
  </select>

  <input id="playlistUrl" type="text" placeholder="Paste Spotify Playlist URL here" />
  <button onclick="loadPlaylist()">Load Playlist</button>

  <div id="loader"></div>

  <p id="message"></p>

  <div id="gameControls" style="display:none;">
    <div id="playerScores" style="text-align:center; margin-bottom:15px; display:none;">
      <span id="player1Score">Player 1 Score: 0</span>
      <span id="player2Score">Player 2 Score: 0</span>
    </div>
    <p id="currentPlayer"></p>
    <p><strong>Score:</strong> <span id="scoreDisplay">0</span></p>

    <button id="playBtn" onclick="playHint()">Play</button>
    <button id="nextHintBtn" onclick="nextHint()">Next Hint</button>
    <button id="giveUpBtn" onclick="revealAnswer()">I Give Up</button>
    <button id="nextSongBtn" onclick="nextTurn()" style="display:none;">Next Song</button>

    <div style="margin-top: 20px;">
      <div class="input-container">
        <input id="guessSongInput" type="text" placeholder="Guess the song name..." autocomplete="off" />
        <div id="songAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>
      <div class="input-container">
        <input id="guessArtistInput" type="text" placeholder="Guess the artist name..." autocomplete="off" />
        <div id="artistAutocomplete" class="autocomplete-list" style="display:none;"></div>
      </div>
      <button id="submitGuessBtn" onclick="submitGuess()">Submit Guess</button>
    </div>

    <p id="hintDuration"></p>
    <p id="feedback"></p>
    <p id="answer" style="display:none;"></p>
  </div>

  <button id="playAgainBtn" onclick="playAgain()" style="display:none; margin-top: 30px;">Play Again</button>

  <script>
    const backendUrl = 'https://guess-the-song-backend.onrender.com';
    let songs = [];
    let usedSongs = new Set();
    let currentSong = null;
    let audio = null;
    let hintStages = [0.5, 1, 2, 5, 10, 15];
    let scoring = [10, 8, 6, 4, 2, 1];
    let currentHintIndex = 0;
    let snippetTimeout = null;
    let score = 0;
    let roundOver = false;

    // For 2-player mode:
    let mode = 'infinite';
    const challengeMaxSongs = 5;
    const challengeGoalPoints = 25;
    let songsPlayed = 0;
    let playerTurn = 1;
    let songsPlayed1 = 0;
    let songsPlayed2 = 0;
    let score1 = 0;
    let score2 = 0;

    const messageP = document.getElementById('message');
    const loader = document.getElementById('loader');
    const playerScoresDiv = document.getElementById('playerScores');
    const player1ScoreSpan = document.getElementById('player1Score');
    const player2ScoreSpan = document.getElementById('player2Score');
    const currentPlayerP = document.getElementById('currentPlayer');

    function updateScore(points) {
      if (mode === '2player') {
        if (playerTurn === 1) {
          score1 += points;
          player1ScoreSpan.textContent = `Player 1 Score: ${Math.round(score1 * 10) / 10}`;
        } else {
          score2 += points;
          player2ScoreSpan.textContent = `Player 2 Score: ${Math.round(score2 * 10) / 10}`;
        }
      } else {
        score += points;
        document.getElementById('scoreDisplay').textContent = Math.round(score * 10) / 10;
      }
    }

    function updatePlayerIndicator() {
      if (mode === '2player') {
        currentPlayerP.textContent = `Current Turn: Player ${playerTurn}`;
        playerScoresDiv.style.display = 'block';
        document.getElementById('scoreDisplay').style.display = 'none';
      } else {
        currentPlayerP.textContent = '';
        playerScoresDiv.style.display = 'none';
        document.getElementById('scoreDisplay').style.display = 'inline-block';
      }
    }

    function extractPlaylistId(url) {
      const match = url.match(/playlist\/([a-zA-Z0-9]+)(\?.*)?$/);
      return match ? match[1] : null;
    }

    async function loadPlaylist() {
      const playlistUrl = document.getElementById('playlistUrl').value.trim();
      const playlistId = extractPlaylistId(playlistUrl);

      if (!playlistId) {
        alert('Please enter a valid Spotify playlist URL.');
        return;
      }

      loader.style.display = 'block';

      try {
        const response = await fetch(`${backendUrl}/playlist/${playlistId}`);
        if (!response.ok) {
          alert('Failed to load playlist.');
          loader.style.display = 'none';
          return;
        }

        const data = await response.json();
        songs = data.filter(song => song.preview_url);
        if (songs.length === 0) {
          alert('No playable songs found.');
          loader.style.display = 'none';
          return;
        }

        mode = document.getElementById('modeSelect').value;
        songsPlayed = 0;
        songsPlayed1 = 0;
        songsPlayed2 = 0;
        playerTurn = 1;
        score = 0;
        score1 = 0;
        score2 = 0;

        updateScore(0);
        updatePlayerIndicator();

        document.getElementById('gameControls').style.display = 'block';
        resetButtons(true);
        document.getElementById('playAgainBtn').style.display = 'none';
        enableInputs(true);
        startNewRound();
      } catch (error) {
        console.error('Error loading playlist:', error);
        alert('Something went wrong.');
      } finally {
        loader.style.display = 'none';
      }
    }

    function resetButtons(active) {
      document.getElementById('playBtn').disabled = !active;
      document.getElementById('nextHintBtn').disabled = !active;
      document.getElementById('giveUpBtn').disabled = !active;
      document.getElementById('submitGuessBtn').disabled = !active;
      document.getElementById('nextSongBtn').style.display = active ? 'none' : 'inline-block';
    }

    function enableInputs(enabled) {
      document.getElementById('guessSongInput').disabled = !enabled;
      document.getElementById('guessArtistInput').disabled = !enabled;
    }

    function startNewRound() {
      if (mode === '2player') {
        if (songsPlayed1 >= challengeMaxSongs && songsPlayed2 >= challengeMaxSongs) {
          endGame();
          return;
        }
      } else if (mode === 'challenge' && songsPlayed >= challengeMaxSongs) {
        endGame();
        return;
      }

      roundOver = false;
      resetButtons(true);
      enableInputs(true);

      clearTimeout(snippetTimeout);
      if (audio) {
        audio.pause();
        audio = null;
      }

      currentHintIndex = 0;
      document.getElementById('answer').style.display = 'none';
      document.getElementById('answer').textContent = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('hintDuration').textContent = '';
      document.getElementById('guessSongInput').value = '';
      document.getElementById('guessArtistInput').value = '';
      hideAutocomplete('songAutocomplete');
      hideAutocomplete('artistAutocomplete');

      let attempts = 0;
      do {
        currentSong = songs[Math.floor(Math.random() * songs.length)];
        attempts++;
      } while (usedSongs.has(currentSong.name + currentSong.artist) && attempts < 10);

      usedSongs.add(currentSong.name + currentSong.artist);

      if (mode === '2player') {
        if (playerTurn === 1 && songsPlayed1 < challengeMaxSongs) {
          songsPlayed1++;
          messageP.textContent = `Player 1: Song ${songsPlayed1} of ${challengeMaxSongs}`;
        } else if (playerTurn === 2 && songsPlayed2 < challengeMaxSongs) {
          songsPlayed2++;
          messageP.textContent = `Player 2: Song ${songsPlayed2} of ${challengeMaxSongs}`;
        }
        updatePlayerIndicator();
      } else if (mode === 'challenge') {
        songsPlayed++;
        messageP.textContent = `Challenge Mode: Song ${songsPlayed} of ${challengeMaxSongs}`;
      } else {
        messageP.textContent = '';
      }
      document.getElementById('playAgainBtn').style.display = 'none';
    }

    function playHint(durationOverride = null) {
      if (!currentSong || !currentSong.preview_url) {
        alert('No preview available.');
        return;
      }

      if (audio) {
        audio.pause();
        audio = null;
      }

      const duration = durationOverride || hintStages[currentHintIndex];
      document.getElementById('hintDuration').textContent = `🎧 Playing hint: ${duration} second${duration > 1 ? 's' : ''}`;

      audio = new Audio(currentSong.preview_url);
      audio.currentTime = 0;

      audio.play().then(() => {
        if (!durationOverride) {
          snippetTimeout = setTimeout(() => {
            audio.pause();
          }, duration * 1000);
        } else {
          snippetTimeout = null;
        }
      }).catch(err => {
        console.error('Audio playback error:', err);
      });
    }

    function nextHint() {
      if (roundOver) return;
      currentHintIndex++;
      if (currentHintIndex >= hintStages.length) {
        revealAnswer(true);
      } else {
        playHint();
      }
    }

    function submitGuess() {
      if (roundOver) return;

      const guessSong = document.getElementById('guessSongInput').value.trim().toLowerCase();
      const guessArtist = document.getElementById('guessArtistInput').value.trim().toLowerCase();
      const songName = currentSong.name.toLowerCase();
      const artistName = currentSong.artist.toLowerCase();

      if (!guessSong && !guessArtist) {
        alert('Please enter a guess for the song or the artist.');
        return;
      }

      const matchSong = guessSong && (songName.includes(guessSong) || guessSong.includes(songName));
      const matchArtist = guessArtist && (artistName.includes(guessArtist) || guessArtist.includes(artistName));
      const matchBoth = matchSong && matchArtist;

      const feedbackEl = document.getElementById('feedback');
      const points = scoring[currentHintIndex] || 0;

      if (matchBoth) {
        feedbackEl.textContent = `✅ Correct! You guessed both song and artist. +${points} pts`;
        updateScore(points);
        showAnswer();
        playHint(30);
        roundOver = true;
        resetButtons(false);
        document.getElementById('nextSongBtn').style.display = 'inline-block';
      } else if (matchSong || matchArtist) {
        const partialPoints = points / 2;
        feedbackEl.textContent = `🟡 Partial match! +${partialPoints} pts`;
        updateScore(partialPoints);
        showAnswer();
        playHint(30);
        roundOver = true;
        resetButtons(false);
        document.getElementById('nextSongBtn').style.display = 'inline-block';
      } else {
        feedbackEl.textContent = `❌ Nope! Try again or use a hint.`;
      }
    }

    function showAnswer() {
      const answerEl = document.getElementById('answer');
      answerEl.textContent = `🎵 ${currentSong.name} — ${currentSong.artist}`;
      answerEl.style.display = 'block';
      document.getElementById('hintDuration').textContent = '';
    }

    function revealAnswer(playFull = true) {
      if (roundOver) return;
      showAnswer();
      roundOver = true;
      resetButtons(false);
      document.getElementById('nextSongBtn').style.display = 'inline-block';

      if (playFull && currentSong.preview_url) {
        if (audio) audio.pause();
        audio = new Audio(currentSong.preview_url);
        audio.play();
      }
    }

    function endGame() {
      resetButtons(false);
      enableInputs(false);
      document.getElementById('nextSongBtn').style.display = 'none';

      if (mode === '2player') {
        let resultMsg = '';
        if (score1 > score2) {
          resultMsg = `🎉 Player 1 wins with ${Math.round(score1)} points! Player 2 scored ${Math.round(score2)} points.`;
        } else if (score2 > score1) {
          resultMsg = `🎉 Player 2 wins with ${Math.round(score2)} points! Player 1 scored ${Math.round(score1)} points.`;
        } else {
          resultMsg = `It's a tie! Both players scored ${Math.round(score1)} points.`;
        }
        messageP.textContent = resultMsg;
      } else if (mode === 'challenge') {
        if (score >= challengeGoalPoints) {
          messageP.textContent = `🎉 Challenge completed! You scored ${Math.round(score)} points!`;
        } else {
          messageP.textContent = `Challenge over! You scored ${Math.round(score)} points. Try again to reach ${challengeGoalPoints}!`;
        }
      } else {
        messageP.textContent = `Game Over! You scored ${Math.round(score)} points.`;
      }

      document.getElementById('playAgainBtn').style.display = 'inline-block';
      currentPlayerP.textContent = '';
      playerScoresDiv.style.display = 'none';
      document.getElementById('scoreDisplay').style.display = 'inline-block';
    }

    function playAgain() {
      usedSongs.clear();
      songsPlayed = 0;
      songsPlayed1 = 0;
      songsPlayed2 = 0;
      playerTurn = 1;
      score = 0;
      score1 = 0;
      score2 = 0;

      updateScore(0);
      updatePlayerIndicator();

      messageP.textContent = '';
      document.getElementById('answer').style.display = 'none';
      document.getElementById('answer').textContent = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('hintDuration').textContent = '';
      document.getElementById('guessSongInput').value = '';
      document.getElementById('guessArtistInput').value = '';
      resetButtons(true);
      enableInputs(true);
      document.getElementById('playAgainBtn').style.display = 'none';
      startNewRound();
    }

    function nextTurn() {
      if (mode === '2player') {
        playerTurn = playerTurn === 1 ? 2 : 1;
      }
      startNewRound();
    }

    // --- Autocomplete features omitted for brevity ---
    // You can keep your existing autocomplete code for guessSongInput and guessArtistInput here

    // Bind mode selector change
    document.getElementById('modeSelect').addEventListener('change', () => {
      // Reset on mode change
      songs = [];
      usedSongs.clear();
      songsPlayed = 0;
      songsPlayed1 = 0;
      songsPlayed2 = 0;
      playerTurn = 1;
      score = 0;
      score1 = 0;
      score2 = 0;

      updateScore(0);
      updatePlayerIndicator();
      messageP.textContent = '';
      document.getElementById('gameControls').style.display = 'none';
      document.getElementById('playAgainBtn').style.display = 'none';
    });
  </script>
</body>

</html>
